name: Generate Go SDK from OpenAPI

on:
  push:
    branches:
      - main
    paths:
      - 'openapi/spec.yaml'
      - '.openapi-version'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-sdk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Check if OpenAPI spec exists
        id: check
        run: |
          if [ ! -f openapi/spec.yaml ]; then
            echo "Error: openapi/spec.yaml not found"
            echo "Please run 'make fetch' locally to fetch the OpenAPI spec first"
            exit 1
          fi

          if [ ! -f .openapi-version ]; then
            echo "Error: .openapi-version not found"
            exit 1
          fi

          VERSION=$(cat .openapi-version)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generating SDK for OpenAPI version: ${VERSION}"

      - name: Setup Java (for OpenAPI Generator)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install OpenAPI Generator
        run: |
          wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/7.2.0/openapi-generator-cli-7.2.0.jar -O openapi-generator-cli.jar

      - name: Clean previous generation
        run: |
          rm -rf client/ docs/ test/

      - name: Generate Go SDK
        run: |
          java -jar openapi-generator-cli.jar generate \
            -i openapi/spec.yaml \
            -g go \
            -o . \
            --git-repo-id arcane-go \
            --git-user-id anujc4 \
            --package-name arcane \
            --additional-properties=packageVersion=${{ steps.check.outputs.version }},isGoSubmodule=false,enumClassPrefix=true,structPrefix=true

      - name: Run go mod tidy
        run: |
          go mod tidy

      - name: Run tests
        run: |
          go test ./... -v || echo "Tests completed with warnings"

      - name: Check for changes
        id: git_status
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi

      - name: Create Pull Request
        if: steps.git_status.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: regenerate Go SDK for version ${{ steps.check.outputs.version }}"
          branch: sdk-update-${{ steps.check.outputs.version }}
          delete-branch: true
          title: 'Regenerate Go SDK for v${{ steps.check.outputs.version }}'
          body: |
            ## SDK Regeneration

            This PR regenerates the Go SDK for the Arcane API.

            ### Changes
            - **API Version**: `${{ steps.check.outputs.version }}`
            - **Generated Code**: Regenerated using OpenAPI Generator

            ### Files Changed
            - Generated Go client code in `client/`
            - Updated documentation in `docs/`
            - Test files in `test/`

            ### Testing
            - [ ] Review generated code changes
            - [ ] Run integration tests
            - [ ] Update examples if needed

            ---
            *Generated by GitHub Actions workflow*
          labels: |
            automated
            sdk-update
          assignees: anujc4

      - name: Summary
        run: |
          echo "### SDK Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **API Version**: ${{ steps.check.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes Detected**: ${{ steps.git_status.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
